---
title: "Stroke Analysis"
output: 
  html_document:
    theme: flatly
    code_folding: hide
    df_print: kable
---

```{r include = FALSE}
# Load libraries & set plot theme
library(here)
library(tidyverse)
library(scales)

```

```{r include = FALSE}
# Make custom theme for plots
theme_strokes <- function(){ 
    
    theme_minimal() %+replace%    #replace elements we want to change
    
    theme(
      
      #grid elements
      panel.grid.major = element_blank(),    #strip major gridlines
      panel.grid.minor = element_blank(),    #strip minor gridlines
      axis.ticks = element_blank(),          #strip axis ticks
      
  
      #text elements
      plot.title = element_text(             #title
                   size = 14,                #set font size
                   face = 'bold',            #bold typeface
                   hjust = 0,                #left align
                   vjust = 2),               #raise slightly
      
      plot.subtitle = element_text(          #subtitle
                   size = 12),               #font size
      
      plot.caption = element_text(           #caption
                   size = 9,                 #font size
                   hjust = 1),               #right align
      
      axis.title = element_text(             #axis titles
                   size = 10),               #font size
      
      axis.text = element_text(              #axis text
                   size = 9),                #font size
      
      axis.text.x = element_text(            #margin for axis text
                    margin=margin(5, b = 10))
    )
}

theme_set(theme_strokes())
```

```{r include = FALSE}
# Read in cleaned stroke data
activity_hb <- read_csv(here("data/clean/activity_hb.csv")) %>% 
  filter(admission_type == "All")
activity_ca <- read_csv(here("data/clean/activity_ca.csv")) %>% 
    filter(admission_type == "All")
mortality_hb <- read_csv(here("data/clean/mortality_hb.csv"))
mortality_ca <- read_csv(here("data/clean/mortality_ca.csv"))
```

```{r}
# Summary of total number of stroke discharges by type
activity_hb %>% 
  filter(hb_name == "Scotland"
         & admission_type == "All"
         & age_group =="All" 
         & sex == "All" 
         & year == 2018 ) %>% 
  group_by(diagnosis, sex, age_group) %>% 
  summarise(discharges = sum(number_of_discharges))
```

```{r}
# Summary of total number of stroke deaths by type
mortality_hb %>% 
  filter(hb_name == "Scotland" 
         & age_group == "All"
         & sex == "All"
         & year == 2018) %>% 
  group_by(year, sex, diagnosis) %>% 
  summarise(total_deaths = sum(number_of_deaths))
```

```{r}
# Total discharges split by diagnosis, 2018
activity_hb %>% 
  filter(hb_name == "Scotland"
           & age_group =="All" 
           & sex == "All" 
           & year == "2018"
         ) %>% 
  group_by(diagnosis) %>% 
  summarise(discharges = sum(number_of_discharges)) %>% 
  ggplot() +
  aes(x = reorder(diagnosis, discharges), 
      y = discharges) +
  geom_col(fill = "blue") +
  labs(title = "Total number of discharges in Scotland, 2018") +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank()
        ) +
  scale_y_continuous(labels = scales::comma,
                     limits = c(0, 35000)) +
  coord_flip()
```

```{r}
# Total discharges split by diagnosis, 2018
mortality_hb %>% 
  filter(hb_name == "Scotland"
           & age_group =="All" 
           & sex == "All" 
           & year == "2018"
         ) %>% 
  group_by(diagnosis) %>% 
  summarise(deaths = sum(number_of_deaths)) %>% 
  ggplot() +
  aes(x = reorder(diagnosis, deaths), 
      y = deaths) +
  geom_col(fill = "blue") +
  labs(title = "Total number of deaths in Scotland, 2018") +
  theme(axis.title.x = element_blank(),
      axis.title.y = element_blank()
      ) +
  scale_y_continuous(labels = scales::comma,
                     limits = c(0, 4500)) +
  coord_flip()
```

```{r}
# Total discharges by sex, diagnosis, age_group
activity_hb %>% 
  filter(hb_name == "Scotland"
           & !age_group %in% c("All", "under75 years") 
           & sex != "All"
           & year == "2018"
         ) %>% 
  group_by(diagnosis, 
           sex,
           age_group
           ) %>% 
  summarise(discharges = sum(number_of_discharges)) %>% 
  ggplot(aes(x = age_group,
             y = discharges,
             fill = sex
             )
         ) +
  geom_col(position = "dodge") +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank()) +
  labs(title = "Total number of discharges in Scotland, 2018") +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(
    values = c(
      "Male" = "springgreen3",
      "Female" = "purple2"
    ))+
  coord_flip() +
  facet_wrap(~ diagnosis)
    
```

